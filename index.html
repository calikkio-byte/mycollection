<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>MY COLLECTION ‚Äî Mobile (volatile, resized photos)</title>
<style>
  :root{ --bg:#0b0c10; --card:#12141a; --muted:#1d2028; --accent:#49c5b6; --text:#e8eaed; --sub:#aab0b9; --ring:#6cf7e9 }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font: 16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:#0b0c10}
  .container{max-width:1100px; margin:0 auto; padding:16px}
  header{position:sticky; top:0; background:rgba(11,12,16,.85); backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid #1b1f27; z-index:20}
  h1{margin:0; letter-spacing:.08em; font-weight:800; font-size:clamp(18px,4vw,28px)}
  .title{display:flex; gap:10px; align-items:center; padding:12px 0}
  .badge{padding:2px 8px; font-size:12px; border:1px solid #2b2f3a; color:#b7bec9; border-radius:999px}
  .row{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
  .card{background:var(--card); border:1px solid #1b1f27; border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block; color:var(--sub); font-size:14px; margin:10px 0 6px}
  input, select, textarea{width:100%; background:#0f1117; color:var(--text); border:1px solid #2b2f3a; border-radius:12px; padding:14px 14px; outline:none; font-size:16px}
  input:focus, select:focus, textarea:focus{border-color:var(--ring); box-shadow:0 0 0 3px rgba(76, 231, 215, .15)}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .actions{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
  button{appearance:none; border:none; padding:12px 14px; border-radius:14px; cursor:pointer; font-weight:700; font-size:16px}
  .btn{background:var(--accent); color:#052522}
  .btn.secondary{background:#242833; color:#e6ebf3}
  .btn.ghost{background:transparent; border:1px solid #2b2f3a; color:#cbd5e1}
  .hint{font-size:12px; color:#98a2b3}
  .table{width:100%; border-collapse:separate; border-spacing:0 8px}
  .table th{font-size:12px; color:#9aa3af; text-align:left; padding:0 8px}
  .table td{background:var(--muted); padding:10px; border-top:1px solid #2a2f39; border-bottom:1px solid #2a2f39}
  .table tr td:first-child{border-left:1px solid #2a2f39; border-top-left-radius:10px; border-bottom-left-radius:10px}
  .table tr td:last-child{border-right:1px solid #2a2f39; border-top-right-radius:10px; border-bottom-right-radius:10px}
  .pill{font-size:12px; padding:6px 10px; border:1px solid #303643; border-radius:999px; color:#c6d0da}
  .flex{display:flex; align-items:center; gap:10px}
  .cat{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:var(--muted); border:1px solid #2b2f3a; border-radius:12px}
  .cat h3{margin:0; font-size:16px}
  .tot{font-size:12px; color:#cbd5e1}
  .collapse{margin-top:10px}
  .collapse[open] summary{border-bottom:1px dashed #2b2f3a; padding-bottom:8px; margin-bottom:8px}
  summary{cursor:pointer}
  .photo{width:48px; height:48px; border-radius:10px; object-fit:cover; border:1px solid #2a2f39}
  footer{margin:70px 0 14px; color:#9aa3af; font-size:12px; text-align:center}
  .owner{display:flex; gap:10px; align-items:center}
  .owner input{max-width:260px}
  .danger{color:#fca5a5}
  @media(max-width:900px){ .row{grid-template-columns:1fr} .grid{grid-template-columns: 1fr} .owner{flex-wrap:wrap} }
  .bottom-bar{position:fixed; bottom:0; left:0; right:0; padding:8px 12px calc(8px + env(safe-area-inset-bottom)); background:rgba(18,20,26,.9); backdrop-filter:saturate(140%) blur(8px); border-top:1px solid #1b1f27; display:flex; gap:8px; z-index:30}
  .bottom-bar button{flex:1}
  .spacer{height:64px}
</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <h1>MY COLLECTION</h1>
        <span class="badge">mobile ‚Ä¢ volatile</span>
      </div>
      <div class="owner">
        <label for="ownerInput" class="hint">Proprietario</label>
        <input id="ownerInput" placeholder="Il tuo nome" />
        <button class="btn secondary" id="clearAllBtn" title="Cancella dati della sessione">Pulisci dati</button>
      </div>
      <small class="hint">‚ö†Ô∏è Versione <strong>senza salvataggio persistente</strong>: i dati si perdono al refresh. Usa Backup JSON per salvarli.</small>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <section class="card" id="formCard">
        <h2 style="margin:0 0 8px">Aggiungi articolo</h2>
        <form id="itemForm">
          <div class="grid">
            <div>
              <label>Categoria</label>
              <input list="catList" id="catInput" placeholder="es. Carte Pok√©mon" required autocomplete="off" />
              <datalist id="catList"></datalist>
            </div>
            <div>
              <label>Sottocategoria</label>
              <input list="subList" id="subInput" placeholder="es. Set Base 1999" autocomplete="off" />
              <datalist id="subList"></datalist>
            </div>
            <div>
              <label>Nome</label>
              <input id="nameInput" placeholder="Nome / Modello" required />
            </div>
            <div>
              <label>Luogo di acquisto</label>
              <input id="placeInput" placeholder="es. eBay, Fiera, Negozio" />
            </div>
            <div>
              <label>Data di acquisto</label>
              <input id="dateInput" type="date" />
            </div>
            <div>
              <label>Prezzo di acquisto (‚Ç¨)</label>
              <input id="priceInput" inputmode="decimal" pattern="[0-9.,]*" placeholder="129,90" />
            </div>
            <div>
              <label>Valore stimato (‚Ç¨)</label>
              <input id="estInput" inputmode="decimal" pattern="[0-9.,]*" placeholder="180" />
            </div>
            <div>
              <label>Foto (ridimensionata automaticamente)</label>
              <input id="photoInput" type="file" accept="image/*" capture="environment" />
            </div>
          </div>
          <label>Descrizione</label>
          <textarea id="descInput" rows="4" placeholder="Dettagli, stato, note"></textarea>
          <div class="actions">
            <button class="btn" type="submit">Aggiungi</button>
            <button class="btn ghost" type="reset">Reset campi</button>
          </div>
          <small class="hint">Le foto vengono ridotte (max 700px lato lungo, JPEG qualit√† ~0.8) e tenute solo in memoria.</small>
        </form>
      </section>

      <aside class="card" id="exportCard">
        <h2 style="margin:0 0 8px">Esporta / Backup</h2>
        <div class="actions">
          <button class="btn secondary" id="exportTxt">TXT</button>
          <button class="btn secondary" id="exportCsv">Excel (CSV)</button>
          <button class="btn secondary" id="exportPdf">PDF</button>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="btn" id="exportJson">Backup JSON</button>
          <label for="importJson" class="btn ghost" style="cursor:pointer">Importa JSON
            <input id="importJson" type="file" accept="application/json" style="display:none" />
          </label>
        </div>
      </aside>
    </div>

    <section class="card" style="margin-top:16px" id="inventoryCard">
      <div class="flex" style="justify-content:space-between; align-items:flex-start; gap:8px; flex-wrap:wrap">
        <h2 style="margin:0">Inventario</h2>
        <div class="flex" style="flex-wrap:wrap">
          <span class="pill" id="totalCount">0 articoli</span>
          <span class="pill" id="grandBuy">Totale acquisti: ‚Ç¨ 0,00</span>
          <span class="pill" id="grandEst">Totale valore stimato: ‚Ç¨ 0,00</span>
        </div>
      </div>
      <div id="catWrapper" style="margin-top:12px"></div>
    </section>
  </main>

  <div class="spacer"></div>
  <div class="bottom-bar">
    <button class="btn" id="goAdd">‚ûï Aggiungi</button>
    <button class="btn secondary" id="goExport">‚¨áÔ∏è Esporta</button>
    <button class="btn ghost" id="goInventory">üì¶ Inventario</button>
  </div>

  <footer>
    Creato con ‚ù§ ‚Äî mobile, sessione volatile (no salvataggio).
    <br><strong>Realizzato da 2M Digital Consulting SRLS</strong>
  </footer>

<script>
// ===== Utility =====
const fmt = new Intl.NumberFormat('it-IT', {style:'currency', currency:'EUR'});
const q = sel => document.querySelector(sel);
const el = (tag, props={}, ...children)=>{ const n=document.createElement(tag); Object.assign(n, props); children.forEach(c=> n.append(c)); return n };
const parseNum = (v)=>{ if(!v) return 0; return parseFloat((''+v).replace(/\./g,'').replace(',', '.')) || 0 };
const uid = ()=>Math.random().toString(36).slice(2,9);

// ===== Photo resize to small DataURL (in-memory) =====
async function fileToResizedDataURL(file, maxDim = 700, quality = 0.8){
  const img = await fileToImage(file);
  const {w,h} = fitContain(img.naturalWidth, img.naturalHeight, maxDim);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL('image/jpeg', quality);
}
function fileToImage(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>{ const img = new Image(); img.onload = ()=> res(img); img.onerror = rej; img.src = fr.result }; 
    fr.onerror = rej; fr.readAsDataURL(file);
  });
}
function fitContain(w, h, max){
  if(!w || !h) return {w: max, h: max};
  const ratio = Math.min(max / w, max / h, 1);
  return {w: Math.round(w * ratio), h: Math.round(h * ratio)};
}

// ===== Smooth scroll anchors =====
q('#goAdd').addEventListener('click', ()=> q('#formCard').scrollIntoView({behavior:'smooth', block:'start'}));
q('#goExport').addEventListener('click', ()=> q('#exportCard').scrollIntoView({behavior:'smooth', block:'start'}));
q('#goInventory').addEventListener('click', ()=> q('#inventoryCard').scrollIntoView({behavior:'smooth', block:'start'}));

// ===== Volatile state (no persistence) =====
let state = { owner:'', cats:[], subs:{}, items:[] };

// ===== DOM refs =====
const ownerInput = q('#ownerInput');
const catInput = q('#catInput');
const subInput = q('#subInput');
const nameInput = q('#nameInput');
const placeInput = q('#placeInput');
const dateInput = q('#dateInput');
const priceInput = q('#priceInput');
const estInput = q('#estInput');
const photoInput = q('#photoInput');
const descInput = q('#descInput');
const catList = q('#catList');
const subList = q('#subList');
const catWrapper = q('#catWrapper');
const totalCount = q('#totalCount');
const grandBuy = q('#grandBuy');
const grandEst = q('#grandEst');

// ===== Init =====
function hydrate(){ ownerInput.value = state.owner || ''; renderCatDatalist(); render(); }
function renderCatDatalist(){
  catList.innerHTML = '';
  [...new Set(state.cats.concat(state.items.map(i=>i.category).filter(Boolean)))].sort().forEach(c=>{ catList.append(el('option',{value:c})) });
}
function renderSubDatalist(cat){
  subList.innerHTML = '';
  const subs = (state.subs[cat]||[]).concat(state.items.filter(i=>i.category===cat).map(i=>i.subcategory||'')).filter(Boolean);
  [...new Set(subs)].sort().forEach(s=> subList.append(el('option',{value:s})));
}
catInput.addEventListener('input', e=> renderSubDatalist(e.target.value));
ownerInput.addEventListener('input', ()=>{ state.owner = ownerInput.value.trim(); });

q('#itemForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const item = {
    id: uid(),
    category: catInput.value.trim(),
    subcategory: subInput.value.trim(),
    name: nameInput.value.trim(),
    description: descInput.value.trim(),
    date: dateInput.value || '',
    place: placeInput.value.trim(),
    price: parseNum(priceInput.value),
    estimate: parseNum(estInput.value),
    photo: null
  };
  if(!item.category || !item.name){ alert('Categoria e Nome sono obbligatori.'); return }

  const file = photoInput.files[0];
  if(file){
    try{ item.photo = await fileToResizedDataURL(file, 700, 0.8); }catch(err){ console.warn(err); item.photo = null; }
  }

  if(item.category && !state.cats.includes(item.category)) state.cats.push(item.category);
  if(item.category){
    state.subs[item.category] = state.subs[item.category] || [];
    if(item.subcategory && !state.subs[item.category].includes(item.subcategory)) state.subs[item.category].push(item.subcategory);
  }

  state.items.push(item);
  (e.target).reset();
  renderCatDatalist(); renderSubDatalist(catInput.value); render();
  window.navigator.vibrate?.(10);
});

q('#clearAllBtn').addEventListener('click', ()=>{
  if(!confirm('Sicuro di voler eliminare TUTTI i dati della sessione?')) return;
  state = { owner:'', cats:[], subs:{}, items:[] };
  hydrate();
});

// ===== Render =====
function groupByCategory(items){
  const map = new Map();
  items.forEach(i=>{
    const key = i.category || 'Senza categoria';
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(i);
  });
  return map;
}

function render(){
  const items = state.items;
  totalCount.textContent = `${items.length} articoli`;
  const grandB = items.reduce((a,b)=>a+(b.price||0),0);
  const grandE = items.reduce((a,b)=>a+(b.estimate||0),0);
  grandBuy.textContent = `Totale acquisti: ${fmt.format(grandB)}`;
  grandEst.textContent = `Totale valore stimato: ${fmt.format(grandE)}`;

  const groups = groupByCategory(items);
  catWrapper.innerHTML='';
  const catsAll = new Set([...state.cats, ...groups.keys()]);
  [...catsAll].sort().forEach(cat=>{
    const list = groups.get(cat)||[];
    const sumBuy = list.reduce((a,b)=>a+(b.price||0),0);
    const sumEst = list.reduce((a,b)=>a+(b.estimate||0),0);

    const section = el('section',{});
    const head = el('div',{className:'cat'},
      el('h3', {textContent:cat||'Senza categoria'}),
      el('div', {className:'tot'}, `${list.length} articoli ‚Ä¢ Somma acquisti: ${fmt.format(sumBuy)} ‚Ä¢ Somma valore: ${fmt.format(sumEst)}`)
    );

    const details = el('details',{className:'collapse'});
    details.append(el('summary',{textContent:'Mostra elenco'}));

    const table = el('table',{className:'table'});
    const thead = el('thead',{});
    thead.append(el('tr',{},
      el('th',{textContent:'Foto'}),
      el('th',{textContent:'Nome'}),
      el('th',{textContent:'Sottocategoria'}),
      el('th',{textContent:'Acquistato il'}),
      el('th',{textContent:'Luogo'}),
      el('th',{textContent:'Prezzo'}),
      el('th',{textContent:'Valore stimato'}),
      el('th',{textContent:'Azioni'})
    ));
    table.append(thead);
    const tbody = el('tbody',{});
    (list.length?list:[]).forEach(i=>{
      const tr = el('tr',{});
      tr.append(
        el('td',{}, i.photo? el('img',{src:i.photo, className:'photo'}): el('span',{className:'hint', textContent:'‚Äî'})),
        el('td',{}, el('strong',{textContent:i.name}), el('div',{className:'hint', textContent:i.description||''})),
        el('td',{textContent:i.subcategory||'‚Äî'}),
        el('td',{textContent: i.date? new Date(i.date).toLocaleDateString('it-IT'): '‚Äî'}),
        el('td',{textContent:i.place||'‚Äî'}),
        el('td',{textContent: i.price? fmt.format(i.price): '‚Äî'}),
        el('td',{textContent: i.estimate? fmt.format(i.estimate): '‚Äî'}),
        el('td',{}, (()=>{ const box = el('div',{className:'actions'});
          const del = el('button',{className:'btn secondary', textContent:'Elimina'}); del.addEventListener('click',()=>delItem(i.id)); box.append(del);
          const edit = el('button',{className:'btn ghost', textContent:'Modifica'}); edit.addEventListener('click',()=>editItem(i.id)); box.append(edit);
          return box })())
      );
      tbody.append(tr);
    });
    table.append(tbody);
    details.append(table);

    section.append(head, details);
    catWrapper.append(section);
  });
}

function delItem(id){
  if(!confirm('Eliminare questo articolo?')) return;
  state.items = state.items.filter(i=>i.id!==id);
  render();
}

function editItem(id){
  const i = state.items.find(x=>x.id===id); if(!i) return;
  catInput.value = i.category; renderSubDatalist(i.category); subInput.value = i.subcategory||'';
  nameInput.value = i.name; descInput.value = i.description||''; dateInput.value = i.date||''; placeInput.value = i.place||'';
  priceInput.value = i.price? i.price.toString().replace('.',',') : '';
  estInput.value = i.estimate? i.estimate.toString().replace('.',',') : '';
  window.scrollTo({top:0, behavior:'smooth'});
  state.items = state.items.filter(x=>x.id!==id);
  render();
}

// ===== Exporters (dalla memoria) =====
function groupedData(){
  const groups = {};
  state.items.forEach(i=>{
    const c = i.category||'Senza categoria';
    groups[c] = groups[c]||{items:[], sumBuy:0, sumEst:0};
    groups[c].items.push(i);
    groups[c].sumBuy += i.price||0; groups[c].sumEst += i.estimate||0;
  });
  return groups;
}

function download(filename, content, type='text/plain'){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = el('a', {href:url, download:filename});
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

q('#exportTxt').addEventListener('click', ()=>{
  const g = groupedData();
  let out = `MY COLLECTION
Proprietario: ${state.owner||'-'}
Generato: ${new Date().toLocaleString('it-IT')}

`;
  Object.keys(g).sort().forEach(cat=>{
    const {items,sumBuy,sumEst} = g[cat];
    out += `# ${cat} (articoli: ${items.length})
Somma acquisti: ${fmt.format(sumBuy)} | Somma valore: ${fmt.format(sumEst)}
`;
    items.forEach((i,idx)=>{
      out += `  ${idx+1}. ${i.name} | Sottocat: ${i.subcategory||'-'} | Data: ${i.date? new Date(i.date).toLocaleDateString('it-IT'):'-'} | Luogo: ${i.place||'-'} | Prezzo: ${i.price? fmt.format(i.price):'-'} | Valore: ${i.estimate? fmt.format(i.estimate):'-'}
     Note: ${i.description||'-'}
`;
    });
    out += '
';
  });
  download(`my-collection_${new Date().toISOString().slice(0,10)}.txt`, out, 'text/plain;charset=utf-8');
});

q('#exportCsv').addEventListener('click', ()=>{
  const rows = [['Categoria','Sottocategoria','Nome','Descrizione','Data acquisto','Luogo','Prezzo acquisto EUR','Valore stimato EUR']];
  state.items.forEach(i=>{
    rows.push([
      i.category||'', i.subcategory||'', i.name||'', (i.description||'').replace(/
/g,' '),
      i.date? new Date(i.date).toLocaleDateString('it-IT'):'', i.place||'',
      (i.price||0).toString().replace('.',','), (i.estimate||0).toString().replace('.',',')
    ]);
  });
  const csv = rows.map(r=> r.map(cell=>`"${(''+cell).replace(/"/g,'""')}"`).join(';')).join('
');
  download(`my-collection_${new Date().toISOString().slice(0,10)}.csv`, csv, 'text/csv;charset=utf-8');
});

q('#exportPdf').addEventListener('click', ()=>{
  const g = groupedData();
  const html = `<!doctype html><html lang='it'><head><meta charset='utf-8'><title>MY COLLECTION ‚Äì PDF</title>
    <style>
      body{font-family: Arial, sans-serif; margin:20px;}
      h1{margin:0 0 6px}
      h2{margin:18px 0 6px; page-break-after:avoid}
      table{width:100%; border-collapse:collapse;}
      th,td{border:1px solid #999; padding:6px; font-size:12px}
      th{background:#efefef}
      .muted{color:#555; font-size:12px}
    </style>
  </head><body>
    <h1>MY COLLECTION</h1>
    <div class='muted'>Proprietario: ${escapeHtml(state.owner||'-')} ‚Ä¢ Generato: ${new Date().toLocaleString('it-IT')}</div>
    ${Object.keys(g).sort().map(cat=>{
      const {items,sumBuy,sumEst} = g[cat];
      return `<h2>${escapeHtml(cat)} ‚Äî ${items.length} articoli</h2>
        <div class='muted'>Somma acquisti: ${fmt.format(sumBuy)} | Somma valore: ${fmt.format(sumEst)}</div>
        <table><thead><tr><th>Nome</th><th>Sottocategoria</th><th>Data</th><th>Luogo</th><th>Prezzo</th><th>Valore</th><th>Note</th></tr></thead>
        <tbody>
        ${items.map(i=>`<tr>
          <td>${escapeHtml(i.name||'')}</td>
          <td>${escapeHtml(i.subcategory||'')}</td>
          <td>${i.date? new Date(i.date).toLocaleDateString('it-IT'):''}</td>
          <td>${escapeHtml(i.place||'')}</td>
          <td>${i.price? fmt.format(i.price):''}</td>
          <td>${i.estimate? fmt.format(i.estimate):''}</td>
          <td>${escapeHtml(i.description||'')}</td>
        </tr>`).join('')}
        </tbody></table>`
    }).join('')}
    <script>window.print()<\/script>
  </body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
});

function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#039;'}[m])); }

// ===== Backup JSON (solo dati, no foto esterne) =====
q('#exportJson').addEventListener('click', ()=>{
  const json = JSON.stringify(state, null, 2);
  download(`my-collection-session_${new Date().toISOString().slice(0,10)}.json`, json, 'application/json');
});
q('#importJson').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const txt = await file.text();
    const data = JSON.parse(txt);
    if(!data || !Array.isArray(data.items)) throw new Error('Formato non valido');
    state = data; hydrate();
  }catch(err){ alert('Import fallito: '+err.message) }
  e.target.value = '';
});

// Start
hydrate();
</script>
</body>
</html>
